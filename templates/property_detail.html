<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Propiedad - Property Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed top-5 right-5 z-50 space-y-2"></div>

    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center">
                        <span class="text-xl font-bold text-gray-800">Property Manager</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <form id="editPropertyForm" class="bg-white overflow-hidden shadow-xl sm:rounded-lg p-6">
            <h1 class="text-2xl font-bold mb-4">Editar Propiedad: {{.Property.NombreAlias}}</h1>
            
            <!-- Tab buttons -->
            <div class="border-b border-gray-200 mb-6">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button type="button" onclick="showTab(1)" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-600" aria-current="page">
                        Detalles del Piso
                    </button>
                    <button type="button" onclick="showTab(2)" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        Plataformas y Finanzas
                    </button>
                    <button type="button" onclick="showTab(3)" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        Servicios y Contactos
                    </button>
                </nav>
            </div>

            <input type="hidden" name="id" value="{{.Property.ID}}">

            <!-- Tab 1: Detalles del Piso -->
            <div id="tab-1" class="tab-content space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Campos existentes... -->
                    <div><label for="nombre_alias" class="block text-sm font-medium text-gray-700">Nombre/Alias</label><input type="text" name="nombre_alias" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" value="{{.Property.NombreAlias}}"></div>
                    <div><label for="direccion_completa" class="block text-sm font-medium text-gray-700">Dirección Completa</label><input type="text" name="direccion_completa" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" value="{{.Property.DireccionCompleta}}"></div>
                    <div><label for="tipo_propiedad" class="block text-sm font-medium text-gray-700">Tipo de Propiedad</label><select name="tipo_propiedad" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"><option value="Piso" {{if eq .Property.TipoPropiedad "Piso"}}selected{{end}}>Piso</option><option value="Apartamento" {{if eq .Property.TipoPropiedad "Apartamento"}}selected{{end}}>Apartamento</option><option value="Casa" {{if eq .Property.TipoPropiedad "Casa"}}selected{{end}}>Casa</option><option value="Ático" {{if eq .Property.TipoPropiedad "Ático"}}selected{{end}}>Ático</option><option value="Duplex" {{if eq .Property.TipoPropiedad "Duplex"}}selected{{end}}>Duplex</option></select></div>
                    <div><label for="capacidad_maxima" class="block text-sm font-medium text-gray-700">Capacidad Máxima</label><input type="number" name="capacidad_maxima" required min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" value="{{.Property.CapacidadMaxima}}"></div>
                    <div><label for="numero_habitaciones" class="block text-sm font-medium text-gray-700">Nº Habitaciones</label><input type="number" name="numero_habitaciones" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" value="{{if .Property.NumeroHabitaciones.Valid}}{{.Property.NumeroHabitaciones.Int64}}{{end}}"></div>
                    <div><label for="numero_banos" class="block text-sm font-medium text-gray-700">Nº Baños</label><input type="number" name="numero_banos" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" value="{{if .Property.NumeroBanos.Valid}}{{.Property.NumeroBanos.Int64}}{{end}}"></div>
                    <div><label for="metros_cuadrados" class="block text-sm font-medium text-gray-700">Metros Cuadrados</label><input type="number" name="metros_cuadrados" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" value="{{if .Property.MetrosCuadrados.Valid}}{{.Property.MetrosCuadrados.Int64}}{{end}}"></div>
                    <div><label for="cedula_habitabilidad" class="block text-sm font-medium text-gray-700">Cédula Habitabilidad</label><input type="text" name="cedula_habitabilidad" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" value="{{if .Property.CedulaHabitabilidad.Valid}}{{.Property.CedulaHabitabilidad.String}}{{end}}"></div>
                    <div><label for="licencia_turistica" class="block text-sm font-medium text-gray-700">Licencia Turística</label><input type="text" name="licencia_turistica" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" value="{{if .Property.LicenciaTuristica.Valid}}{{.Property.LicenciaTuristica.String}}{{end}}"></div>
                    <div class="md:col-span-2"><label for="descripcion_corta" class="block text-sm font-medium text-gray-700">Descripción Corta</label><textarea name="descripcion_corta" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">{{if .Property.DescripcionCorta.Valid}}{{.Property.DescripcionCorta.String}}{{end}}</textarea></div>
                    
                    <!-- CORRECCIÓN: Campo de Amenidades como etiquetas -->
                    <div class="md:col-span-2">
                        <label for="amenitiesInput" class="block text-sm font-medium text-gray-700">Amenidades</label>
                        <div class="flex flex-wrap items-center gap-2 p-2 mt-1 border border-gray-300 rounded-md">
                            <div id="amenitiesTagContainer" class="flex flex-wrap gap-2"></div>
                            <input type="text" id="amenitiesInput" placeholder="Añadir y pulsar Enter..." class="flex-1 min-w-[150px] border-none outline-none bg-transparent p-1">
                        </div>
                        <input type="hidden" name="amenidades" id="amenidadesHidden">
                    </div>
                </div>
            </div>

            <!-- Tab 2 y 3 (sin cambios) -->
            <div id="tab-2" class="tab-content space-y-4 hidden"><!-- ... --></div>
            <div id="tab-3" class="tab-content space-y-4 hidden"><!-- ... --></div>

            <!-- Action Buttons -->
            <div class="mt-8 flex justify-between items-center">
                <button type="button" onclick="deleteProperty('{{.Property.ID}}')" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700">Eliminar</button>
                <div class="flex space-x-4">
                    <a href="/" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">Volver</a>
                    <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Guardar Cambios</button>
                </div>
            </div>
        </form>
    </div>

    <script>
        let amenityTags = [];

        // --- Lógica para las pestañas (sin cambios) ---
        function showTab(tabNumber) { /* ... */ }

        // --- Lógica para las etiquetas de Amenidades ---
        function initializeAmenities() {
            const amenitiesString = "{{if .Property.Amenidades.Valid}}{{.Property.Amenidades.String}}{{end}}";
            if (amenitiesString) {
                amenityTags = amenitiesString.split(',').map(t => t.trim()).filter(t => t);
                renderAmenityTags();
            }
        }

        function renderAmenityTags() {
            const container = document.getElementById('amenitiesTagContainer');
            const hiddenInput = document.getElementById('amenidadesHidden');
            container.innerHTML = '';
            amenityTags.forEach((tag, index) => {
                const tagElement = document.createElement('span');
                tagElement.className = 'inline-flex items-center px-2 py-1 bg-gray-200 text-gray-800 text-sm font-medium rounded';
                const textNode = document.createTextNode(tag);
                const removeButton = document.createElement('button');
                removeButton.type = 'button';
                removeButton.className = 'ml-2 text-gray-500 hover:text-gray-700';
                removeButton.innerHTML = '&times;';
                removeButton.addEventListener('click', () => removeAmenityTag(index));
                tagElement.appendChild(textNode);
                tagElement.appendChild(removeButton);
                container.appendChild(tagElement);
            });
            hiddenInput.value = amenityTags.join(',');
        }

        function removeAmenityTag(index) {
            amenityTags.splice(index, 1);
            renderAmenityTags();
        }

        document.getElementById('amenitiesInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const newTag = this.value.trim();
                if (newTag && !amenityTags.includes(newTag)) {
                    amenityTags.push(newTag);
                    renderAmenityTags();
                }
                this.value = '';
            }
        });

        // --- Lógica del formulario (actualizada) ---
        document.getElementById('editPropertyForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const id = formData.get('id');

            // La función createNullableString ya existe en tu código, la usamos aquí
            const createNullableString = (value) => ({ String: value, Valid: value != null && value.trim() !== '' });
            const createNullable = (value, type) => { /* ... */ };

            const property = {
                // ... otros campos
                amenidades: createNullableString(formData.get('amenidades')), // Se obtiene del input oculto
                // ... otros campos
            };
            
            // El resto de la lógica de envío...
        });
        
        // --- Inicialización ---
        window.addEventListener('DOMContentLoaded', () => {
            showTab(1);
            initializeAmenities();
        });

        // ... resto del script
    </script>
</body>
</html>
